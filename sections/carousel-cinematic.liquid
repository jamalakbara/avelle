{% schema %}
{
  "name": "Cinematic Carousel",
  "tag": "section",
  "settings": [
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "New Arrivals"
    }
  ],
  "presets": [
    {
      "name": "Cinematic Carousel"
    }
  ]
}
{% endschema %}

{% assign collection = section.settings.collection %}
{% assign slide_width_max = '380px' %}

<avelle-carousel-section
  class="parallax-carousel-container"
  style="position: relative; padding: 64px 0; background: var(--color-background); display: block;"
>
  <div style="padding: 0 var(--util-page-margin-offset, 2rem); margin-bottom: 32px; display: flex; justify-content: space-between; align-items: flex-end;">
    <h2 style="font-size: clamp(2rem, 4vw, 3rem); font-weight: 300; margin: 0; text-transform: uppercase;">
      {{ section.settings.heading }}
    </h2>
    {% if collection != blank %}
      <a href="{{ collection.url }}" class="link">Shop All</a>
    {% endif %}
  </div>

  <div
    class="parallax-carousel-wrapper cursor-none"
    style="--slide-width-max: {{ slide_width_max }}; overflow-x: auto; scroll-snap-type: x mandatory; display: flex; gap: 8px; padding-inline: var(--util-page-margin-offset, 2rem); scrollbar-width: none; -ms-overflow-style: none; -webkit-overflow-scrolling: touch; cursor: none;"
    data-parallax-carousel
  >
    {% if collection != blank and collection.products_count > 0 %}
      {% for product in collection.products limit: 6 %}
        <a href="{{ product.url }}" class="parallax-card" style="text-decoration: none; color: inherit;">
          <div class="product-card-gallery">
            <img
              src="{{ product.featured_image | image_url: width: 600 }}"
              alt="{{ product.title | escape }}"
              width="600"
              height="900"
              loading="lazy"
            >
            <div class="quick-add-wrapper product-form-buttons">
              <button class="add-to-cart-button button" aria-label="Add {{ product.title }} to cart">
                <span class="add-to-cart-text__content">{{ 'products.product.add_to_cart' | t }}</span>
              </button>
            </div>
          </div>
          <div class="curated-card__info" style="padding-top: 16px;">
            <h3 class="curated-card__title">{{ product.title }}</h3>
            <div class="curated-card__price">
              {% if product.available == false %}
                <span class="badge-sold-out">Sold Out</span>
              {% else %}
                {{ product.price | money }}
                {% if product.compare_at_price > product.price %}
                  <span class="compare-at-price" style="text-decoration: line-through; opacity: 0.6; margin-left: 8px;">
                    {{- product.compare_at_price | money -}}
                  </span>
                {% endif %}
              {% endif %}
            </div>
          </div>
        </a>
      {% endfor %}
    {% else %}
      {% for i in (1..6) %}
        <div class="parallax-card">
          <div class="product-card-gallery">
            {{ 'product-apparel-' | append: i | placeholder_svg_tag: 'placeholder-svg' }}
          </div>
        </div>
      {% endfor %}
    {% endif %}
  </div>

  <div class="parallax-drag-cursor" data-drag-cursor>
    <span>Drag</span>
  </div>
</avelle-carousel-section>

<style>
  .parallax-carousel-wrapper::-webkit-scrollbar {
    display: none;
  }

  .parallax-carousel-wrapper .parallax-card {
    scroll-snap-align: start;
    flex: 0 0 calc(var(--slide-width-max) + 0px);
    max-width: var(--slide-width-max);
    width: 80vw;
    position: relative;
    overflow: hidden;
    border-radius: 0;
    cursor: none;
    display: flex;
    flex-direction: column;
    height: 100%;
  }

  .product-card-gallery {
    position: relative;
    width: 100%;
    padding-top: 150%; /* exactly 2:3 aspect ratio */
    overflow: hidden;
    background: #f4f4f4;
  }

  .product-card-gallery img {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .curated-card__info {
    text-align: center;
    padding-bottom: 20px; /* Prevent text from being clipped by overflow: hidden when translateY is active */
  }

  .curated-card__title {
    font-size: var(--font-size--product_info);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin: 0 0 0.25rem 0;
    font-weight: 500;
  }

  .curated-card__price {
    font-size: var(--font-size--product_info);
    opacity: 0.7;
  }

  /* Custom Hover Reveals for Add to Cart */
  .parallax-carousel-wrapper .parallax-card .quick-add-wrapper {
    position: absolute;
    bottom: var(--padding-sm, 16px);
    left: var(--padding-sm, 16px);
    right: var(--padding-sm, 16px);
    opacity: 0;
    transform: translateY(20px);
    z-index: 10;
    transition: opacity 0.4s ease, transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
  }

  /* Image Overlay on Hover */
  .parallax-carousel-wrapper .parallax-card .product-card-gallery::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.25);
    opacity: 0;
    transition: opacity 0.5s ease;
    pointer-events: none;
    z-index: 5;
  }

  .parallax-carousel-wrapper .parallax-card:hover .product-card-gallery::after {
    opacity: 1;
  }

  .parallax-carousel-wrapper .parallax-card:hover .quick-add-wrapper {
    opacity: 1;
    transform: translateY(0);
    transition-delay: 0.1s;
  }

  /* Info Hover Animation */
  .parallax-carousel-wrapper .parallax-card .curated-card__info {
    transform: translateY(10px);
    opacity: 0.8;
    transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1);
  }

  .parallax-carousel-wrapper .parallax-card:hover .curated-card__info {
    transform: translateY(0);
    opacity: 1;
  }

  /* Cinematic Add To Cart Button Overrides (Matching PDP styles) */
  .parallax-carousel-wrapper .parallax-card .quick-add-wrapper.product-form-buttons .add-to-cart-button {
    border-radius: 999px !important; /* Pill shape */
    text-transform: uppercase !important;
    letter-spacing: 0.1em !important;
    font-weight: 500 !important;
    padding-block: 1.2rem !important;
    transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1) !important;
    background: transparent !important; /* Transparent fill */
    color: #fff !important; /* White foreground over images */
    border: 1px solid #fff !important; /* White border */
    box-shadow: none !important;
    width: 100% !important;
    display: flex;
    justify-content: center;
    align-items: center;
    /* Ensure the cursor-none from the parent is overridden so we can actually click it! */
    cursor: pointer !important;
  }

  .parallax-carousel-wrapper .parallax-card .quick-add-wrapper.product-form-buttons .add-to-cart-button:hover {
    transform: translateY(-2px) !important;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
    background: #fff !important; /* Fill white on hover */
    color: #000 !important; /* Black text on hover */
  }

  /* Custom Cursor Styles */
  .parallax-carousel-wrapper {
    cursor: none;
  }
  .parallax-carousel-wrapper * {
    cursor: none !important;
  }

  .parallax-drag-cursor {
    position: absolute;
    top: 0;
    left: 0;
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.9);
    color: #000;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 1px;
    pointer-events: none;
    z-index: 100;
    opacity: 0;
    mix-blend-mode: exclusion;
    will-change: transform;
  }

  /* Make the text change or icon appear when dragging if desired */
  .parallax-drag-cursor.is-dragging span {
    font-size: 12px;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    if (typeof gsap === 'undefined' || typeof ScrollTrigger === 'undefined') return;

    const containers = document.querySelectorAll('.parallax-carousel-container');

    containers.forEach((container) => {
      // Prevent double initialization if script runs twice
      if (container.dataset.parallaxInitialized) return;
      container.dataset.parallaxInitialized = 'true';

      const wrapper = container.querySelector('.parallax-carousel-wrapper');
      const cursor = container.querySelector('[data-drag-cursor]');

      if (!wrapper) return;

      if (cursor) {
        let mouseX = 0,
          mouseY = 0;
        let cursorX = 0,
          cursorY = 0;

        // Take over transform control via GSAP
        gsap.set(cursor, { xPercent: -50, yPercent: -50, scale: 0.5 });

        // Track mouse ONLY over the wrapper, but relative to the container for absolute positioning
        wrapper.addEventListener('mousemove', (e) => {
          const rect = container.getBoundingClientRect();
          mouseX = e.clientX - rect.left;
          mouseY = e.clientY - rect.top;
        });

        wrapper.addEventListener('mouseenter', (e) => {
          // Snap instantly to actual mouse location to prevent "flying in from 0,0" delay!
          const rect = container.getBoundingClientRect();
          mouseX = e.clientX - rect.left;
          mouseY = e.clientY - rect.top;
          cursorX = mouseX;
          cursorY = mouseY;
          gsap.set(cursor, { x: cursorX, y: cursorY });

          gsap.to(cursor, { opacity: 1, scale: 0.5, duration: 0.3 });
        });

        wrapper.addEventListener('mouseleave', () => {
          gsap.to(cursor, { opacity: 0, scale: 0.5, duration: 0.3 });
        });

        // Add drag state for cursor
        wrapper.addEventListener('mousedown', () => {
          cursor.classList.add('is-dragging');
          gsap.to(cursor, { scale: 0.4, background: 'rgba(255, 255, 255, 1)', duration: 0.2 });
        });

        window.addEventListener('mouseup', () => {
          cursor.classList.remove('is-dragging');
          gsap.to(cursor, { scale: 0.5, background: 'rgba(255, 255, 255, 0.9)', duration: 0.2 });
        });

        gsap.ticker.add(() => {
          cursorX += (mouseX - cursorX) * 0.15;
          cursorY += (mouseY - cursorY) * 0.15;
          gsap.set(cursor, { x: cursorX, y: cursorY });
        });
      }

      const cards = container.querySelectorAll('.parallax-card');

      cards.forEach((card) => {
        // Image parallax animation temporarily removed
      });
    });
  });
</script>
