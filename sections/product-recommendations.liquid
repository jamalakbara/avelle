{% schema %}
{
  "name": "Product Recommendations",
  "tag": "section",
  "class": "section-product-recommendations",
  "settings": [
    {
      "type": "text",
      "id": "subheading",
      "label": "Subheading",
      "default": "You Might Also Like"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Recommended For You"
    },
    {
      "type": "select",
      "id": "text_alignment",
      "label": "Text Alignment",
      "options": [
        {
          "value": "left",
          "label": "Left"
        },
        {
          "value": "center",
          "label": "Center"
        }
      ],
      "default": "center"
    },
    {
      "type": "select",
      "id": "products_alignment",
      "label": "Products Alignment",
      "options": [
        {
          "value": "left",
          "label": "Left"
        },
        {
          "value": "center",
          "label": "Center"
        }
      ],
      "default": "left"
    },
    {
      "type": "select",
      "id": "recommendation_type",
      "label": "Recommendation Type",
      "options": [
        {
          "value": "related",
          "label": "Related"
        },
        {
          "value": "complementary",
          "label": "Complementary"
        }
      ],
      "default": "related"
    },
    {
      "type": "range",
      "id": "max_products",
      "label": "Maximum Products",
      "min": 2,
      "max": 8,
      "step": 1,
      "default": 4
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color Scheme",
      "default": "scheme-1"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Padding Top",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Padding Bottom",
      "default": 36
    }
  ],
  "presets": [
    {
      "name": "Product Recommendations"
    }
  ]
}
{% endschema %}

{%- style -%}
  .section-curated-products {
    padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
    padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
    overflow: hidden; /* Essential for parallax */
  }

  @media screen and (min-width: 750px) {
    .section-curated-products {
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
    }
  }

  .curated-products__header {
    text-align: {{ section.settings.text_alignment }};
    margin-bottom: 4rem;
    padding: 0 2rem;
  }

  .curated-products__subheading {
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    opacity: 0.7;
    margin-bottom: 0.5rem;
    display: block;
  }

  .curated-products__heading {
    font-size: clamp(2.5rem, 5vw, 4rem);
    text-transform: uppercase;
    font-weight: 300;
    margin: 0;
    line-height: 1.1;
  }

  /* Grid Layout (Left Aligned by default) */
  .curated-products__grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr); /* 2 columns on mobile */
    gap: 1rem;
    padding: 0 1rem;
    max-width: 1600px;
    margin: 0 auto;
  }

  /* Center Alignment uses Flexbox for accurate centering of variable items */
  .curated-products__grid--center {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 1rem;
  }

  .curated-products__grid--center .curated-card {
    width: calc(50% - 0.5rem); /* Mobile width logic for flex */
  }

  @media screen and (min-width: 768px) {
    .curated-products__grid {
      grid-template-columns: repeat(4, 1fr); /* 4 columns on desktop */
      gap: 2vw;
      padding: 0 4vw;
      align-items: start; /* Allow items to slide vertically independently */
    }

    .curated-products__grid--center {
      display: flex; /* Override grid */
      justify-content: center;
      gap: 2vw;
    }

    .curated-products__grid--center .curated-card {
      width: calc(25% - 1.5vw); /* Desktop width logic for flex, accounting for gap */
      /* Note: Parallax logic remains compatible as long as structure is list of cards */
    }
  }

  /* Product Card */
  .curated-card {
    position: relative;
    display: block;
    text-decoration: none;
    color: inherit;
    width: 100%;
    margin-bottom: 2rem;
  }

  .curated-card__image-wrapper {
    position: relative;
    width: 100%;
    /* Aspect ratio 2:3 for vertical elegance */
    padding-bottom: 140%;
    margin-bottom: 1.5rem;
    overflow: hidden;
    background: #f4f4f4;
  }

  .curated-card__image {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.7s cubic-bezier(0.16, 1, 0.3, 1);
  }

  /* Hover Effects */
  @media screen and (min-width: 768px) {
    .curated-card:hover .curated-card__image {
      transform: scale(1.05);
    }
  }

  .curated-card__info {
    text-align: {{ section.settings.text_alignment }};
  }

  .curated-card__title {
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin: 0 0 0.25rem 0;
    font-weight: 500;
  }

  .curated-card__price {
    font-size: 0.9rem;
    opacity: 0.7;
  }

  /* Asymmetric Offsets (Desktop Only) */
  @media screen and (min-width: 768px) {
    /*
      Concept:
      - Item 1: Starts standard
      - Item 2: Starts lower (margin-top)
      - Item 3: Starts standard
      - Item 4: Starts lower
    */
    .curated-card:nth-child(even) {
      margin-top: 15vh; /* Initial structural offset */
    }
  }

  .curated-card__image-wrapper {
    cursor: pointer;
  }
{%- endstyle -%}

<script src="{{ 'product-recommendations.js' | asset_url }}" type="module" fetchpriority="low" defer="defer"></script>

<product-recommendations
  id="product-recommendations-{{ section.id }}"
  class="product-recommendations section-curated-products color-{{ section.settings.color_scheme }}"
  data-url="{{ routes.product_recommendations_url }}?limit={{ section.settings.max_products }}"
  data-section-id="{{ section.id }}"
  data-product-id="{{ product.id }}"
  data-intent="{{ section.settings.recommendation_type }}"
  data-recommendations-performed="{{ recommendations.performed }}"
>
  {% if recommendations.performed and recommendations.products_count > 0 %}
    <div class="curated-products__header">
      {% if section.settings.subheading != blank %}
        <span class="curated-products__subheading reveal-text">{{ section.settings.subheading }}</span>
      {% endif %}
      {% if section.settings.heading != blank %}
        <h2 class="curated-products__heading reveal-text">{{ section.settings.heading }}</h2>
      {% endif %}
    </div>

    <div class="curated-products__grid {% if section.settings.products_alignment == 'center' %}curated-products__grid--center{% endif %}">
      {% for product in recommendations.products %}
        <a href="{{ product.url }}" class="curated-card" data-curated-card>
          <div class="curated-card__image-wrapper">
            {%- if product.featured_media -%}
              {{
                product.featured_media
                | image_url: width: 1000
                | image_tag: class: 'curated-card__image', loading: 'lazy', widths: '375, 550, 750, 1100'
              }}
            {%- else -%}
              {{ 'product-' | append: forloop.index | placeholder_svg_tag: 'curated-card__image placeholder-svg' }}
            {%- endif -%}
          </div>
          <div class="curated-card__info">
            <h3 class="curated-card__title">{{ product.title }}</h3>
            <div class="curated-card__price">
              {% if product.available == false %}
                <span class="badge-sold-out">Sold Out</span>
              {% else %}
                {{ product.price | money }}
              {% endif %}
            </div>
          </div>
        </a>
      {% endfor %}
    </div>
  {% endif %}
</product-recommendations>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const initAnimations = () => {
      // Check if GSAP is available
      if (typeof gsap === 'undefined' || typeof ScrollTrigger === 'undefined') return;

      gsap.registerPlugin(ScrollTrigger);

      // Refresh ScrollTrigger to ensure positions are calculated correctly after injection
      ScrollTrigger.refresh();

      // Desktop Parallax
      if (window.matchMedia('(min-width: 768px)').matches) {
        const cards = document.querySelectorAll('.product-recommendations .curated-card');

        cards.forEach((card, i) => {
          // Odd items (0, 2) move slower
          // Even items (1, 3) move faster (opposite direction or enhanced scroll)
          const speed = i % 2 !== 0 ? 50 : -30; // Different speeds for asymmetry

          gsap.to(card, {
            y: speed,
            ease: 'none',
            scrollTrigger: {
              trigger: '.section-product-recommendations',
              start: 'top bottom', // Start triggering when the top of the section enters the bottom of the viewport
              end: 'bottom top', // End when the bottom of the section leaves the top of the viewport
              scrub: true,
            },
          });
        });

        // Text Reveal
        const texts = document.querySelectorAll('.product-recommendations .reveal-text');
        texts.forEach((text) => {
          gsap.fromTo(
            text,
            { y: 50, opacity: 0 },
            {
              y: 0,
              opacity: 1,
              duration: 1,
              ease: 'power3.out',
              scrollTrigger: {
                trigger: text,
                start: 'top 85%',
              },
            }
          );
        });
      }
    };

    const recommendationsElement = document.querySelector('product-recommendations');

    if (recommendationsElement) {
      const observer = new MutationObserver((mutations) => {
        for (const mutation of mutations) {
          if (
            mutation.attributeName === 'data-recommendations-performed' &&
            recommendationsElement.dataset.recommendationsPerformed === 'true'
          ) {
            // Wait a tick for DOM update to finalize if needed, though attribute change usually implies innerHTML is done
            setTimeout(initAnimations, 100);
            observer.disconnect();
          }
        }
      });

      observer.observe(recommendationsElement, { attributes: true });

      // If already performed (e.g. back button cache or fast load), init immediately
      if (recommendationsElement.dataset.recommendationsPerformed === 'true') {
        initAnimations();
      }
    }
  });
</script>
