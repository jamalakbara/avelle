{% schema %}
{
  "name": "Cinematic Collections",
  "tag": "section",
  "class": "section-cinematic-collections",
  "settings": [
    {
      "type": "select",
      "id": "height",
      "label": "Section Height",
      "info": "Only applies when Image Ratio is set to 'Full Screen'.",
      "options": [
        { "value": "50vh", "label": "Small (50vh)" },
        { "value": "75vh", "label": "Medium (75vh)" },
        { "value": "100vh", "label": "Full Screen (100vh)" }
      ],
      "default": "100vh"
    },
    {
      "type": "select",
      "id": "image_ratio",
      "label": "Image Ratio",
      "options": [
        { "value": "full", "label": "Full Screen (Original)" },
        { "value": "adapt", "label": "Adapt to Image" },
        { "value": "portrait", "label": "Portrait (2:3)" },
        { "value": "square", "label": "Square (1:1)" }
      ],
      "default": "full"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color Scheme",
      "default": "scheme-1"
    },
    {
      "type": "range",
      "id": "overlay_opacity",
      "min": 0,
      "max": 90,
      "step": 10,
      "unit": "%",
      "label": "Image Overlay Opacity",
      "default": 30
    },
    {
      "type": "range",
      "id": "title_size",
      "min": 20,
      "max": 120,
      "step": 2,
      "unit": "px",
      "label": "Title Size",
      "default": 60
    },
    {
      "type": "header",
      "content": "Animation"
    }
  ],
  "blocks": [
    {
      "type": "collection_item",
      "name": "Collection",
      "limit": 5,
      "settings": [
        {
          "type": "collection",
          "id": "collection",
          "label": "Collection"
        },
        {
          "type": "text",
          "id": "title",
          "label": "Custom Title",
          "info": "Overrides the default collection title."
        },
        {
          "type": "image_picker",
          "id": "image_desktop",
          "label": "Desktop Image",
          "info": "Overrides the collection image on desktop. 16:9 Landscape recommended."
        },
        {
          "type": "image_picker",
          "id": "image_mobile",
          "label": "Mobile Image",
          "info": "Overrides the image on mobile. Portrait recommended."
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Cinematic Collections",
      "blocks": [
        {
          "type": "collection_item"
        },
        {
          "type": "collection_item"
        },
        {
          "type": "collection_item"
        }
      ]
    }
  ]
}
{% endschema %}

{%- style -%}
  .cinematic-list {
    position: relative;
    width: 100%;
    overflow: hidden;
  }

  .cinematic-item {
    position: relative;
    width: 100%;
    height: var(--section-height, 100vh);
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  }

  /* Aspect Ratio Modifiers */
  .cinematic-item--portrait {
    height: auto;
    aspect-ratio: 2 / 3;
  }

  .cinematic-item--square {
    height: auto;
    aspect-ratio: 1 / 1;
  }

  .cinematic-item--adapt {
    height: auto;
  }

  .cinematic-item--adapt .cinematic-image-wrapper {
    position: relative;
    height: auto;
  }

  .cinematic-item--adapt .cinematic-image {
    position: relative;
    height: auto;
    top: auto;
  }

  .cinematic-image-wrapper {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1;
    overflow: hidden;
  }

  /* Default Image Style (Coverage & Parallax Ready) */
  .cinematic-image {
    width: 100%;
    height: 150%;
    object-fit: cover;
    object-position: center;
    position: absolute;
    top: -25%;
    left: 0;
    will-change: transform;
  }

  /* Reset for Adapt/Ratio modes if needed inside specific contexts */
  .cinematic-item--adapt .cinematic-image,
  .cinematic-item--portrait .cinematic-image,
  .cinematic-item--square .cinematic-image {
    /* For portrait/square, we MIGHT want to keep 150% height for parallax if possible. 
        But if 'adapt' is used, we definitely want natural height. */
  }

  .cinematic-item--adapt .cinematic-image {
    height: auto;
    top: 0;
    position: relative;
  }

  .cinematic-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #000;
    z-index: 2;
    pointer-events: none;
  }

  .cinematic-content {
    position: relative;
    z-index: 3;
    text-align: center;
    color: #fff;
    padding: 2rem;
    /* max-width: 800px; Removed for centering */
    opacity: 0;
    transform: translateY(20px);

    /* Ensure content centers properly in ratio modes */
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    position: absolute;
    top: 0;
    left: 0;
  }

  .cinematic-item .cinematic-content .cinematic-title {
    font-size: var(--title-size);
    text-transform: uppercase;
    line-height: 0.9;
    margin-bottom: 2rem;
    font-weight: 300;
    letter-spacing: -0.04em;
  }

  @media screen and (max-width: 768px) {
    .cinematic-item .cinematic-content .cinematic-title {
      font-size: calc(var(--title-size) * 0.6); /* Scale down automatically for mobile */
    }
  }

  .cinematic-button {
    display: inline-block;
    padding: 1.2rem 3rem;
    border: 1px solid rgba(255, 255, 255, 0.4);
    border-radius: 999px;
    text-decoration: none;
    text-transform: uppercase;
    font-size: 0.8rem;
    letter-spacing: 0.1em;
    transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    background: rgba(0, 0, 0, 0.2);
    color: #fff;
    backdrop-filter: blur(10px);
  }

  .cinematic-button:hover {
    background: #fff;
    color: #000;
    border-color: #fff;
    transform: scale(1.05);
  }
{%- endstyle -%}

{%- liquid
  assign ratio_class = ''
  if section.settings.image_ratio == 'portrait'
    assign ratio_class = 'cinematic-item--portrait'
  elsif section.settings.image_ratio == 'square'
    assign ratio_class = 'cinematic-item--square'
  elsif section.settings.image_ratio == 'adapt'
    assign ratio_class = 'cinematic-item--adapt'
  endif
-%}

<div
  class="cinematic-list color-{{ section.settings.color_scheme }}"
  style="--section-height: {{ section.settings.height }}; --title-size: {{ section.settings.title_size }}px;"
>
  {%- for block in section.blocks -%}
    {%- assign collection = block.settings.collection -%}
    {%- assign image_desktop = block.settings.image_desktop | default: collection.image -%}
    {%- assign image_mobile = block.settings.image_mobile -%}
    {%- assign custom_title = block.settings.title | default: collection.title | default: 'Collection Title' -%}

    {%- comment -%} Determine classes for Desktop Image {%- endcomment -%}
    {%- assign desktop_class = 'cinematic-image' -%}
    {%- if image_mobile != blank -%}
      {%- assign desktop_class = desktop_class | append: ' hidden--mobile' -%}
    {%- endif -%}

    <div class="cinematic-item {{ ratio_class }}" {{ block.shopify_attributes }}>
      <div class="cinematic-image-wrapper">
        {%- if image_desktop != blank -%}
          {%- if section.settings.image_ratio == 'adapt' -%}
            {{
              image_desktop
              | image_url: width: 2000
              | image_tag:
                class: desktop_class,
                loading: 'lazy',
                sizes: '100vw',
                widths: '375, 550, 750, 1100, 1500, 1780, 2000, 3000'
            }}
          {%- else -%}
            {{
              image_desktop
              | image_url: width: 2000
              | image_tag:
                class: desktop_class,
                loading: 'lazy',
                sizes: '100vw',
                widths: '375, 550, 750, 1100, 1500, 1780, 2000, 3000'
            }}
          {%- endif -%}
        {%- else -%}
          {%- assign placeholder_class = desktop_class | append: ' placeholder-svg' -%}
          {{ 'collection-1' | placeholder_svg_tag: placeholder_class }}
        {%- endif -%}

        {%- if image_mobile != blank -%}
          {{
            image_mobile
            | image_url: width: 1000
            | image_tag:
              class: 'cinematic-image hidden--desktop',
              loading: 'lazy',
              sizes: '100vw',
              widths: '375, 550, 750, 1100'
          }}
        {%- endif -%}
      </div>

      <div class="cinematic-overlay" style="opacity: {{ section.settings.overlay_opacity | divided_by: 100.0 }}"></div>

      <div class="cinematic-content">
        <h2 class="cinematic-title h1">
          {{ custom_title }}
        </h2>
        <a href="{{ collection.url }}" class="cinematic-button"> Explore Collection </a>
      </div>
    </div>
  {%- else -%}
    {%- for i in (1..3) -%}
      <div class="cinematic-item {{ ratio_class }}">
        <div class="cinematic-image-wrapper">
          {{ 'collection-' | append: i | placeholder_svg_tag: 'cinematic-image placeholder-svg' }}
        </div>
        <div
          class="cinematic-overlay"
          style="opacity: {{ section.settings.overlay_opacity | divided_by: 100.0 }}"
        ></div>
        <div class="cinematic-content">
          <h2 class="cinematic-title h1">Example Collection {{ i }}</h2>
          <a href="#" class="cinematic-button">Explore</a>
        </div>
      </div>
    {%- endfor -%}
  {%- endfor -%}
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    gsap.registerPlugin(ScrollTrigger);

    const items = document.querySelectorAll('.cinematic-item');
    const isAdapt = {{ section.settings.image_ratio | json }} === 'adapt';

    items.forEach((item) => {
      // Select all images (desktop + mobile) within this item
      const images = item.querySelectorAll('.cinematic-image');
      const content = item.querySelector('.cinematic-content');

      // Parallax for Images (Disable for adapt mode)
      if (images.length > 0 && !isAdapt) {
        gsap.fromTo(
          images,
          { yPercent: -15 },
          {
            yPercent: 15,
            ease: 'none',
            scrollTrigger: {
              trigger: item,
              start: 'top bottom',
              end: 'bottom top',
              scrub: true,
            },
          }
        );
      } else if (isAdapt && images.length > 0) {
         // Reset transform if switching modes dynamically without reload (less likely in liquid but good safety)
         images.forEach(img => gsap.set(img, { clearProps: "all" }));
      }

      // Text Reveal
      gsap.to(content, {
        opacity: 1,
        y: 0,
        duration: 1,
        ease: 'power3.out',
        scrollTrigger: {
          trigger: item,
          start: 'top 60%',
          toggleActions: 'play none none reverse',
        },
      });
    });
  });
</script>
