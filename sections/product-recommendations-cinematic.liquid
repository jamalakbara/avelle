{% schema %}
{
  "name": "Cinematic Recommendations",
  "tag": "section",
  "class": "section-curated-products section-product-recommendations",
  "settings": [
    {
      "type": "text",
      "id": "subheading",
      "label": "Subheading",
      "default": "You may also like"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Recommended for You"
    },
    {
      "type": "range",
      "id": "product_limit",
      "min": 2,
      "max": 8,
      "step": 2,
      "default": 4,
      "label": "Product Limit"
    },
    {
      "type": "collection",
      "id": "fallback_collection",
      "label": "Fallback Collection (Empty Cart)",
      "info": "Shows when recommendation engine has no data (e.g. empty cart)."
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color Scheme",
      "default": "scheme-1"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Padding Top",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Padding Bottom",
      "default": 36
    }
  ],
  "presets": [
    {
      "name": "Cinematic Recommendations"
    }
  ]
}
{% endschema %}

{%- style -%}
  .section-product-recommendations {
    padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
    padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
    overflow: hidden; /* Essential for parallax */
  }

  @media screen and (min-width: 750px) {
    .section-product-recommendations {
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
    }
  }

  .curated-products__header {
    text-align: center;
    margin-bottom: 4rem;
    padding: 0 2rem;
  }

  .curated-products__subheading {
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    opacity: 0.7;
    margin-bottom: 0.5rem;
    display: block;
  }

  .curated-products__heading {
    font-size: clamp(2.5rem, 5vw, 4rem);
    text-transform: uppercase;
    font-weight: 300;
    margin: 0;
    line-height: 1.1;
  }

  /* Grid Layout */
  .curated-products__grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr); /* 2 columns on mobile */
    gap: 1rem;
    padding: 0 1rem;
    max-width: 1600px;
    margin: 0 auto;
  }

  @media screen and (min-width: 768px) {
    .curated-products__grid {
      grid-template-columns: repeat(4, 1fr); /* 4 columns on desktop */
      gap: 2vw;
      padding: 0 4vw;
      align-items: start; /* Allow items to slide vertically independently */
    }
  }

  /* Product Card */
  .curated-card {
    position: relative;
    display: block;
    text-decoration: none;
    color: inherit;
    width: 100%;
    margin-bottom: 2rem;
  }

  .curated-card__image-wrapper {
    position: relative;
    width: 100%;
    /* Aspect ratio 2:3 for vertical elegance */
    padding-bottom: 140%;
    margin-bottom: 1.5rem;
    overflow: hidden;
    background: #f4f4f4;
  }

  .curated-card__image {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.7s cubic-bezier(0.16, 1, 0.3, 1);
  }

  /* Hover Effects */
  @media screen and (min-width: 768px) {
    .curated-card:hover .curated-card__image {
      transform: scale(1.05);
    }
  }

  .curated-card__info {
    text-align: center;
  }

  .curated-card__title {
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin: 0 0 0.25rem 0;
    font-weight: 500;
  }

  .curated-card__price {
    font-size: 0.9rem;
    opacity: 0.7;
  }

  /* Asymmetric Offsets (Desktop Only) */
  @media screen and (min-width: 768px) {
    /*
      Concept:
      - Item 1: Starts standard
      - Item 2: Starts lower (margin-top)
      - Item 3: Starts standard
      - Item 4: Starts lower
    */
    .curated-card:nth-child(even) {
      margin-top: 15vh; /* Initial structural offset */
    }
  }

  /* Custom Cursor Area is handled globally by theme or section specific if needed.
     For now, we use simple CSS cursor.
  */
  .curated-card__image-wrapper {
    cursor: pointer;
  }
{%- endstyle -%}

{%- liquid
  assign limit = section.settings.product_limit
  assign product_id = cart.items.first.product_id | default: product.id
  assign fallback_collection = section.settings.fallback_collection

  # Determine mode: 'recommendations' (dynamic) vs 'collection' (static fallback)
  assign mode = 'recommendations'
  if product_id == blank and fallback_collection != blank
    assign mode = 'collection'
  endif
-%}

<div class="color-{{ section.settings.color_scheme }} section-product-recommendations">
  {%- if mode == 'recommendations' -%}
    <product-recommendations
      class="product-recommendations"
      data-url="{{ routes.product_recommendations_url }}?section_id={{ section.id }}&product_id={{ product_id }}&limit={{ limit }}"
    >
      {% if recommendations.performed and recommendations.products_count > 0 %}
        <div class="curated-products__header">
          {% if section.settings.subheading != blank %}
            <span class="curated-products__subheading reveal-text">{{ section.settings.subheading }}</span>
          {% endif %}
          {% if section.settings.heading != blank %}
            <h2 class="curated-products__heading reveal-text">{{ section.settings.heading }}</h2>
          {% endif %}
        </div>

        <div class="curated-products__grid">
          {%- for product in recommendations.products -%}
            <a href="{{ product.url }}" class="curated-card" data-curated-card>
              <div class="curated-card__image-wrapper">
                {%- if product.featured_media -%}
                  {{
                    product.featured_media
                    | image_url: width: 1000
                    | image_tag: class: 'curated-card__image', loading: 'lazy', widths: '375, 550, 750, 1100'
                  }}
                {%- else -%}
                  {{ 'product-' | append: forloop.index | placeholder_svg_tag: 'curated-card__image placeholder-svg' }}
                {%- endif -%}
              </div>
              <div class="curated-card__info">
                <h3 class="curated-card__title">{{ product.title }}</h3>
                <div class="curated-card__price">
                  {% if product.available == false %}
                    <span class="badge-sold-out">Sold Out</span>
                  {% else %}
                    {{ product.price | money }}
                  {% endif %}
                </div>
              </div>
            </a>
          {%- endfor -%}
        </div>
      {% endif %}
    </product-recommendations>
  {%- elsif mode == 'collection' and fallback_collection != blank -%}
    <!-- Fallback Collection Mode (Server Side Render) -->
    <div class="curated-products__header">
      {% if section.settings.subheading != blank %}
        <span class="curated-products__subheading reveal-text">{{ section.settings.subheading }}</span>
      {% endif %}
      {% if section.settings.heading != blank %}
        <h2 class="curated-products__heading reveal-text">{{ section.settings.heading }}</h2>
      {% endif %}
    </div>
    <div class="curated-products__grid">
      {%- for product in collections[fallback_collection].products limit: limit -%}
        <a href="{{ product.url }}" class="curated-card" data-curated-card>
          <div class="curated-card__image-wrapper">
            {%- if product.featured_media -%}
              {{
                product.featured_media
                | image_url: width: 1000
                | image_tag: class: 'curated-card__image', loading: 'lazy', widths: '375, 550, 750, 1100'
              }}
            {%- else -%}
              {{ 'product-' | append: forloop.index | placeholder_svg_tag: 'curated-card__image placeholder-svg' }}
            {%- endif -%}
          </div>
          <div class="curated-card__info">
            <h3 class="curated-card__title">{{ product.title }}</h3>
            <div class="curated-card__price">
              {% if product.available == false %}
                <span class="badge-sold-out">Sold Out</span>
              {% else %}
                {{ product.price | money }}
              {% endif %}
            </div>
          </div>
        </a>
      {%- endfor -%}
    </div>
  {%- endif -%}
</div>

<script>
  class ProductRecommendations extends HTMLElement {
    constructor() {
      super();
    }

    connectedCallback() {
      const handleIntersection = (entries, observer) => {
        if (!entries[0].isIntersecting) return;
        observer.unobserve(this);

        fetch(this.dataset.url)
          .then((response) => response.text())
          .then((text) => {
            const html = document.createElement('div');
            html.innerHTML = text;
            const recommendations = html.querySelector('product-recommendations');

            if (recommendations && recommendations.innerHTML.trim().length) {
              this.innerHTML = recommendations.innerHTML;
              this.initAnimations();
            }
          })
          .catch((e) => {
            console.error(e);
          });
      };

      new IntersectionObserver(handleIntersection.bind(this), { rootMargin: '0px 0px 200px 0px' }).observe(this);
    }

    initAnimations() {
      if (typeof gsap === 'undefined' || typeof ScrollTrigger === 'undefined') return;

      gsap.registerPlugin(ScrollTrigger);

      // Desktop Parallax
      if (window.matchMedia('(min-width: 768px)').matches) {
        const cards = this.querySelectorAll('.curated-card');

        cards.forEach((card, i) => {
          const speed = i % 2 !== 0 ? 50 : -30;

          gsap.to(card, {
            y: speed,
            ease: 'none',
            scrollTrigger: {
              trigger: this,
              start: 'top bottom',
              end: 'bottom top',
              scrub: true,
            },
          });
        });

        // Text Reveal
        const texts = this.querySelectorAll('.reveal-text');
        texts.forEach((text) => {
          gsap.fromTo(
            text,
            { y: 50, opacity: 0 },
            {
              y: 0,
              opacity: 1,
              duration: 1,
              ease: 'power3.out',
              scrollTrigger: {
                trigger: text,
                start: 'top 85%',
              },
            }
          );
        });
      }
    }
  }

  customElements.define('product-recommendations', ProductRecommendations);
</script>
